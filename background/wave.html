<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="UTF-8">

        <title>wave</title>
    </head>

    <body>
        <canvas id="glcanvas" style="border: 2px solid black;" width="1920" height="1080"></canvas>
        
        <label>RotateY :</label>
        <input id="rotateY" type="range" min="0" max="360" step="1" value="0">
        <label>plane posX:</label>
        <input id="posX" type="number" value="0">
         <label>plane posY:</label>
        <input id="posY" type="number" value="0">
         <label>plane posZ:</label>
        <input id="posZ" type="number" value="0">
    </body>

    <script type="module">
        const cubeVertexData = new Float32Array([
                // 前面 z = +0.5
                -0.5, -0.5, 0.5,
                0.5, -0.5, 0.5,
                0.5, 0.5, 0.5,

                -0.5, -0.5, 0.5,
                0.5, 0.5, 0.5,
                -0.5, 0.5, 0.5,

                // 后面 z = -0.5
                0.5, -0.5, -0.5,
                -0.5, -0.5, -0.5,
                -0.5, 0.5, -0.5,

                0.5, -0.5, -0.5,
                -0.5, 0.5, -0.5,
                0.5, 0.5, -0.5,

                // 左面 x = -0.5
                -0.5, -0.5, -0.5,
                -0.5, -0.5, 0.5,
                -0.5, 0.5, 0.5,

                -0.5, -0.5, -0.5,
                -0.5, 0.5, 0.5,
                -0.5, 0.5, -0.5,

                // 右面 x = +0.5
                0.5, -0.5, 0.5,
                0.5, -0.5, -0.5,
                0.5, 0.5, -0.5,

                0.5, -0.5, 0.5,
                0.5, 0.5, -0.5,
                0.5, 0.5, 0.5,

                // 上面 y = +0.5
                -0.5, 0.5, 0.5,
                0.5, 0.5, 0.5,
                0.5, 0.5, -0.5,

                -0.5, 0.5, 0.5,
                0.5, 0.5, -0.5,
                -0.5, 0.5, -0.5,

                // 下面 y = -0.5
                -0.5, -0.5, -0.5,
                0.5, -0.5, -0.5,
                0.5, -0.5, 0.5,

                -0.5, -0.5, -0.5,
                0.5, -0.5, 0.5,
                -0.5, -0.5, 0.5,
            ]);
        import {waveShader} from "./shader_util.mjs"
        import {CoordSysShader} from "./shader_util.mjs"

        import {mat4} from './toji-gl-matrix-1f872b8/dist/esm/index.js'
        import {vec3} from './toji-gl-matrix-1f872b8/dist/esm/index.js';
        import {vec4} from './toji-gl-matrix-1f872b8/dist/esm/index.js';

        import * as webglUtil from "./webgl_util.mjs"
        
        const canvas = document.getElementById("glcanvas");
        const gl = canvas.getContext('webgl');
        const program = webglUtil.initProgram(gl, waveShader.vertexShaderSource, waveShader.fragmentShaderSource);
        const CoordProgram = webglUtil.initProgram(gl, CoordSysShader.vertexShaderSource, CoordSysShader.fragmentShaderSource);

        const plane = new webglUtil.PlaneMesh();
        plane.position = [0, 0, 0];
        plane.rotateXYZ = [90, 0, 0];
        plane.size = [500, 500];
        plane.sub = 90;
        const camera = new webglUtil.Camera();
        camera.position = [-80, 50, 80];
        camera.near = 0.01;
        camera.far = null;
        camera.fov = 110 * Math.PI / 180;
        
        const rY = document.getElementById("rotateY");
        rY.addEventListener('input', function(e){
            plane.rotateXYZ[1] = this.value;
        });

        const posX = document.getElementById("posX");
        posX.addEventListener('input', function(e){
            plane.position[0] = this.value;
        });

        const posY = document.getElementById("posY");
        posY.addEventListener('input', function(e){
            plane.position[1] = this.value;
        });

        const posZ = document.getElementById("posZ");
        posZ.addEventListener('input', function(e){
            plane.position[2] = this.value;
        });

        function draw(currentTime)
        {
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            gl.clearColor(1.0, 1.0, 1.0, 1.0);
            gl.enable(gl.DEPTH_TEST);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            const m = mat4.create();
            const v = camera.getViewMatrix();
            const p = camera.getProjectionMatrix(canvas);

            const m_mvp = mat4.create();
            mat4.multiply(m_mvp, v, m);
            mat4.multiply(m_mvp, p, m_mvp);

            
            
            // gl.useProgram(CoordProgram);
            // const coordUniformInfoLoc = CoordSysShader.getuniformInfoLoc(gl, CoordProgram);
            // const coordUniformInfo = {
            //     mvp : m_mvp,
            //     resolution : [gl.canvas.width, gl.canvas.height]
            // }

            // CoordSysShader.setAttribute(gl, CoordProgram);
            // CoordSysShader.setUniformInfo(gl, coordUniformInfoLoc, coordUniformInfo);
            // gl.drawArrays(gl.LINES, 0 , 6);

            gl.useProgram(program);
            const waveUniformInfoLoc = waveShader.getuniformInfoLoc(gl, program);
            const waveUniformInfo = {
                mvp : m_mvp,
                resolution : [gl.canvas.width, gl.canvas.height],
                time : currentTime
            };

            const vertexData = plane.getVertexData();
            waveShader.setAttribute(gl, program, vertexData);
            waveShader.setUniformInfo(gl, waveUniformInfoLoc, waveUniformInfo);

            gl.drawArrays(gl.LINES, 0 , vertexData.length / 3);
        }

        function render(currentTime)
        {
            draw(currentTime);
            requestAnimationFrame(render);
        };

    render();
    </script>
</html>